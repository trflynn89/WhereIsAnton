function median(e){e.sort(function(e,t){return e-t});var t=Math.floor(e.length/2);return e.length%2==0?(e[t-1]+e[t])/2:e[t]}function getLocations(e){getAPI("/locations/",{limit:e?null:1},showLocations)}function getClusters(){getAPI("/locations/",{limit:null},showClusters)}function getDrunks(){getAPI("/drunk/",{limit:1},showDrunks)}function timeComparator(e,t){return e.time<t.time?1:e.time>t.time?-1:0}function showLocations(e){e.sort(timeComparator),clearMap();for(var t=[],n=0;n<e.length;++n){var r=e[n].latitude,a=e[n].longitude,o=e[n].address,s=addMarker(r,a,o);t[n]=s}fitCoordinates(t),drawPaths()}function showClusters(e){e.sort(timeComparator),clearMap();for(var t=[],n=0;n<e.length;++n){var r=e[n].latitude,a=e[n].longitude,o=new GLatLng(r,a);t[n]=o}fitCoordinates(t),drawCentroids(t)}function showDrunks(e){var t=getName();if(0===e.length)return void Lobibox.alert("error",{title:"Nope!",msg:t+" has never been drunk :("});var n=e[0].drunk,r=new Date(e[0].time).getTime(),a=(new Date).getTime(),o=Math.ceil((a-r)/MILLIS_PER_HOUR),s=n?"Yes!":"Nope!",i=n?" drunk ":" sober ",l=1===o?" hour":" hours",u=n?" :)":" :(",p=n?"info":"error",c=t+" has been"+i+"for "+o+l+u;Lobibox.alert(p,{title:s,msg:c})}function clearMap(){for(var e=0;e<s_markers.length;++e)s_markers[e].setMap(null);for(var e=0;e<s_centroids.length;++e)s_centroids[e].setMap(null);for(var e=0;e<s_paths.length;++e)s_paths[e].arrow.setMap(null),s_paths[e].curve.setMap(null);s_markers=[],s_centroids=[],s_paths=[]}function addMarker(e,t,n){for(var r=new GLatLng(e,t),a=new GMarker({position:r,optimized:!1,zIndex:1,map:s_map}),o=0;o<s_markers.length;++o)if(s_markers[o].position.equals(r)){a.setMap(null);break}return labelMarker(a,n),s_markers.push(a),r}function labelMarker(e,t){var n=e.getMap();if(null!==n&&void 0!==t){var r=new GInfoWindow({content:t});r.open(e.getMap(),e),e.addListener("click",function(){r.open(e.getMap(),e)})}}function fitCoordinates(e){for(var t=null,n=null,r=null,a=null,o=0;o<e.length;++o){var s=e[o].lat(),i=e[o].lng();t=t?Math.max(t,s):s,n=n?Math.min(n,s):s,r=r?Math.max(r,i):i,a=a?Math.min(a,i):i}s_map.fitBounds(new GLatLngBounds(new GLatLng(n,a),new GLatLng(t,r)))}function drawPaths(){for(var e=1;e<s_markers.length;++e){var t=s_markers[e-1].getPosition(),n=s_markers[e].getPosition();s_paths.push({start:t,end:n,curvature:calcCurvature(t,n),arrow:new GPolyline({strokeOpacity:0,map:s_map}),curve:new GMarker({clickable:!1,optimized:!1,zIndex:0,map:s_map})})}updatePaths()}function updatePaths(){for(var e=s_map.getZoom(),t=1/Math.pow(2,-e),n=0;n<s_paths.length;++n){var r=s_paths[n],a=bezierCurve(r);null!==a?(e>MAX_ZOOM?r.arrow.setOptions({icons:null}):r.arrow.setOptions({path:bezierTangent(a),icons:[{offset:"50%",icon:{path:GSymbolPath.BACKWARD_CLOSED_ARROW,strokeColor:"#993333",fillColor:"#993333",strokeWeight:2,strokeOpacity:1,fillOpacity:1}}]}),r.curve.setOptions({position:r.start,icon:{path:bezierToSvg(a),scale:t,strokeColor:"#993333",strokeWeight:2}})):(r.arrow.setOptions({icons:null}),r.curve.setOptions({icon:null}))}}function bezierCurve(e){var t=s_map.getProjection();if(void 0===t)return null;var n=t.fromLatLngToPoint(e.start),r=t.fromLatLngToPoint(e.end),a=new GPoint(r.x-n.x,r.y-n.y),o=new GPoint(a.x/2,a.y/2),s=new GPoint(a.y,-a.x),i=new GPoint(o.x+e.curvature*s.x,o.y+e.curvature*s.y);return{projection:t,p1:n,p2:r,c:i,e:a}}function bezierTangent(e){var t=e.c.x/2,n=e.c.y/2,r=(e.c.x+e.e.x)/2,a=(e.c.y+e.e.y)/2,o=new GPoint(e.p1.x+t,e.p1.y+n),s=new GPoint(e.p1.x+r,e.p1.y+a),i=e.projection.fromPointToLatLng(o),l=e.projection.fromPointToLatLng(s);return[i,l]}function bezierToSvg(e){return"M 0,0 q "+e.c.x+","+e.c.y+" "+e.e.x+","+e.e.y}function calcCurvature(e,t){for(var n=.05,r=0;r<s_paths.length;++r){var a=s_paths[r];arePathsSimilar(a.start,a.end,e,t)&&(n+=.05)}return n}function arePathsSimilar(e,t,n,r){var a=GDistance(e,n)/METERS_PER_MILE,o=GDistance(t,r)/METERS_PER_MILE,s=GDistance(e,r)/METERS_PER_MILE,i=GDistance(t,n)/METERS_PER_MILE;return 100>a&&100>o||100>s&&100>i}function drawCentroids(e){var t=clusterSize();1>t&&(t=Math.floor(Math.sqrt(e.length/2)),t=Math.max(t,MIN_CLUSTERS)),s_clusters=kmedian(e,t);for(var n=0;n<s_clusters.centroids.length;++n)s_centroids[n]=new GPolygon({strokeColor:"#FF0000",strokeOpacity:.8,strokeWeight:2,fillColor:"#FF0000",fillOpacity:.35,map:s_map});updateCentroids()}function updateCentroids(){var e=s_map.getZoom(),t=50;e>0&&(t*=1/e);for(var n=0;n<s_centroids.length;++n){var r=s_clusters.counts.reduce(function(e,t){return e+t}),a=s_clusters.counts[n]/r;a=Math.max(a,.25),s_centroids[n].setOptions({path:drawCircle(s_clusters.centroids[n],a*t)})}}function drawCircle(e,t){var n=s_map.getProjection(),r=new Array;if(void 0===n)return r;for(var a=n.fromLatLngToPoint(e),o=0;360>o;o+=10){var s=t*Math.cos(o*Math.PI/180),i=t*Math.sin(o*Math.PI/180),l=new GPoint(a.x+s,a.y+i);r.push(n.fromPointToLatLng(l))}return r}function kmedian(e,t){for(var n=computeCentroids(e,t),r=new Array(e.length),a=new Array(t),o=!1,s=0;s<e.length;++s)r[s]=-1;for(var s=0;t>s;++s)a[s]=0;for(;!o;){var i=new Array(t);o=!0;for(var s=0;t>s;++s)i[s]={count:0,lats:[],lngs:[]};for(var s=0;s<e.length;++s){for(var l=0,u=GDistance(n[0],e[s]),p=1;t>p;++p){var c=GDistance(n[p],e[s]);u>c&&(u=c,l=p)}o&=r[s]===l,r[s]=l,i[l].lats.push(e[s].lat()),i[l].lngs.push(e[s].lng()),++i[l].count}for(var s=0;t>s;++s)if((a[s]=i[s].count)>0){var g=median(i[s].lats),m=median(i[s].lngs);n[s]=new GLatLng(g,m)}}return{centroids:n,counts:a}}function computeCentroids(e,t){var n=new Array(t),r=new Array(e.length),a=0,o=e[Math.floor(Math.random()*e.length)];n[0]=o;for(var s=0;s<e.length;++s){var i=GDistance(o,e[s]);a+=Math.pow(i,2),r[s]={probability:a,distance:i}}for(var s=1;s<n.length;++s){var l=Math.floor(Math.random()*a);for(o=0;o<e.length&&!(l<r[o].probability);++o);for(var u=0,a=0;u<e.length;++u){var i=GDistance(e[o],e[u]);i<r[u].distance&&(a+=Math.pow(i,2),r[u]={probability:a,distance:i})}n[s]=e[o]}return n}function getAPI(e,t,n){$.get(e,t,function(e){null!==e.exception&&console.log("Exception raised: "+e.exception),null!==n&&n(e.data)})}function postAPI(e,t,n){$.post(e,t,function(e){null!==n&&n(e)})}var s_map=null,s_markers=[],s_clusters=[],s_centroids=[],s_paths=[],MILLIS_PER_HOUR=36e5,METERS_PER_MILE=1609.34,MIN_CLUSTERS=4,MAX_ZOOM=5,GMap=google.maps.Map,GPoint=google.maps.Point,GMarker=google.maps.Marker,GPolygon=google.maps.Polygon,GPolyline=google.maps.Polyline,GSymbolPath=google.maps.SymbolPath,GLatLng=google.maps.LatLng,GLatLngBounds=google.maps.LatLngBounds,GStyledMapType=google.maps.StyledMapType,GInfoWindow=google.maps.InfoWindow,GDistance=google.maps.geometry.spherical.computeDistanceBetween,GEvent=google.maps.event,s_style=[{featureType:"administrative",elementType:"labels.text.fill",stylers:[{color:"#444444"}]},{featureType:"landscape",elementType:"all",stylers:[{color:"#f2f2f2"}]},{featureType:"poi",elementType:"all",stylers:[{visibility:"off"}]},{featureType:"road",elementType:"all",stylers:[{saturation:-100},{lightness:45}]},{featureType:"road.highway",elementType:"all",stylers:[{visibility:"simplified"}]},{featureType:"road",elementType:"labels",stylers:[{visibility:"off"}]},{featureType:"road.arterial",elementType:"labels.icon",stylers:[{visibility:"off"}]},{featureType:"transit",elementType:"all",stylers:[{visibility:"off"}]},{featureType:"water",elementType:"all",stylers:[{color:"#46bcec"},{visibility:"on"}]}];$(document).ready(function(){s_map=new GMap(document.getElementById("map"),{center:new GLatLng(0,0),disableDefaultUI:!0,maxZoom:10,zoom:2}),s_map.mapTypes.set("s_style",new GStyledMapType(s_style)),s_map.setMapTypeId("s_style"),GEvent.addListener(s_map,"zoom_changed",updatePaths),GEvent.addListener(s_map,"zoom_changed",updateCentroids);var e=dataToShow();"drunk"===e?(getLocations(!1),getDrunks()):"history"===e?getLocations(!0):"cluster"==e?getClusters():getLocations(!1)});
