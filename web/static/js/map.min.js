function getLocations(e){getAPI("/locations/",{limit:e?null:1},showLocations)}function getClusters(){getAPI("/locations/",{limit:null},showClusters)}function getDrunks(){getAPI("/drunk/",{limit:1},showDrunks)}function timeComparator(e,t){return e.time<t.time?1:e.time>t.time?-1:0}function showLocations(e){e.sort(timeComparator),clearMap();for(var t=[],a=0;a<e.length;++a){var n=e[a].latitude,o=e[a].longitude,s=e[a].address,r=addMarker(n,o,s);t[a]=r}fitCoordinates(t),drawPaths()}function showClusters(e){e.sort(timeComparator),clearMap();for(var t=clusterSize(),a=[],n=[],o=0;o<e.length;++o){var s=e[o].latitude,r=e[o].longitude,i=new GLatLng(s,r);n[o]={x:r,y:s},a[o]=i}fitCoordinates(a),s_kmpp.reset(),s_kmpp.setPoints(n),-1===t?(s_kmpp.guessK(),s_kmpp.k=Math.max(s_kmpp.k,MIN_CLUSTERS)):(s_kmpp.k=t,s_kmpp.k=Math.max(s_kmpp.k,1)),s_kmpp.initCentroids(),s_kmpp.cluster();for(var o=0;o<s_kmpp.centroids.length;++o){var l=s_kmpp.centroids[o];s_centroids[o]=new google.maps.Circle({center:{lat:l.y,lng:l.x},strokeColor:"#FF0000",strokeOpacity:.8,strokeWeight:2,fillColor:"#FF0000",fillOpacity:.35,map:s_map})}updateCentroids()}function updateCentroids(){var e=s_map.getZoom(),t=4e6;e>0&&(t*=1/e);for(var a=0;a<s_centroids.length;++a){var n=s_kmpp.centroids[a].items/s_kmpp.points.length;n=Math.max(n,.25),s_centroids[a].setOptions({radius:n*t})}}function showDrunks(e){var t=getName();if(0===e.length)return void Lobibox.alert("error",{title:"Nope!",msg:t+" has never been drunk :("});var a=e[0].drunk,n=new Date(e[0].time).getTime(),o=(new Date).getTime(),s=Math.ceil((o-n)/MILLIS_PER_HOUR),r=a?"Yes!":"Nope!",i=a?" drunk ":" sober ",l=1===s?" hour":" hours",p=a?" :)":" :(",u=a?"info":"error",m=t+" has been"+i+"for "+s+l+p;Lobibox.alert(u,{title:r,msg:m})}function clearMap(){for(var e=0;e<s_markers.length;++e)s_markers[e].setMap(null);for(var e=0;e<s_centroids.length;++e)s_centroids[e].setMap(null);for(var e=0;e<s_paths.length;++e)s_paths[e].arrow.setMap(null),s_paths[e].curve.setMap(null);s_markers=[],s_centroids=[],s_paths=[]}function addMarker(e,t,a){for(var n=new GLatLng(e,t),o=new GMarker({position:n,optimized:!1,zIndex:1,map:s_map}),s=0;s<s_markers.length;++s)if(s_markers[s].position.equals(n)){o.setMap(null);break}return labelMarker(o,a),s_markers.push(o),n}function labelMarker(e,t){var a=e.getMap();if(null!==a&&void 0!==t){var n=new GInfoWindow({content:t});n.open(e.getMap(),e),e.addListener("click",function(){n.open(e.getMap(),e)})}}function fitCoordinates(e){for(var t=null,a=null,n=null,o=null,s=0;s<e.length;++s){var r=e[s].lat(),i=e[s].lng();t=t?Math.max(t,r):r,a=a?Math.min(a,r):r,n=n?Math.max(n,i):i,o=o?Math.min(o,i):i}s_map.fitBounds(new GLatLngBounds(new GLatLng(a,o),new GLatLng(t,n)))}function drawPaths(){for(var e=1;e<s_markers.length;++e){var t=s_markers[e-1].getPosition(),a=s_markers[e].getPosition();s_paths.push({start:t,end:a,curvature:calcCurvature(t,a),arrow:new GPolyline({strokeOpacity:0,map:s_map}),curve:new GMarker({clickable:!1,optimized:!1,zIndex:0,map:s_map})})}updatePaths()}function updatePaths(){for(var e=s_map.getZoom(),t=1/Math.pow(2,-e),a=0;a<s_paths.length;++a){var n=s_paths[a],o=bezierCurve(n);null!==o?(e>MAX_ZOOM?n.arrow.setOptions({icons:null}):n.arrow.setOptions({path:bezierTangent(o),icons:[{offset:"50%",icon:{path:GSymbolPath.BACKWARD_CLOSED_ARROW,strokeColor:"#993333",fillColor:"#993333",strokeWeight:2,strokeOpacity:1,fillOpacity:1}}]}),n.curve.setOptions({position:n.start,icon:{path:bezierToSvg(o),scale:t,strokeColor:"#993333",strokeWeight:2}})):(n.arrow.setOptions({icons:null}),n.curve.setOptions({icon:null}))}}function bezierCurve(e){var t=s_map.getProjection();if(void 0===t)return null;var a=t.fromLatLngToPoint(e.start),n=t.fromLatLngToPoint(e.end),o=new GPoint(n.x-a.x,n.y-a.y),s=new GPoint(o.x/2,o.y/2),r=new GPoint(o.y,-o.x),i=new GPoint(s.x+e.curvature*r.x,s.y+e.curvature*r.y);return{projection:t,p1:a,p2:n,c:i,e:o}}function bezierTangent(e){var t=e.c.x/2,a=e.c.y/2,n=(e.c.x+e.e.x)/2,o=(e.c.y+e.e.y)/2,s=new GPoint(e.p1.x+t,e.p1.y+a),r=new GPoint(e.p1.x+n,e.p1.y+o),i=e.projection.fromPointToLatLng(s),l=e.projection.fromPointToLatLng(r);return[i,l]}function bezierToSvg(e){return"M 0,0 q "+e.c.x+","+e.c.y+" "+e.e.x+","+e.e.y}function calcCurvature(e,t){for(var a=.05,n=0;n<s_paths.length;++n){var o=s_paths[n];arePathsSimilar(o.start,o.end,e,t)&&(a+=.05)}return a}function arePathsSimilar(e,t,a,n){var o=GDistance(e,a)/METERS_PER_MILE,s=GDistance(t,n)/METERS_PER_MILE,r=GDistance(e,n)/METERS_PER_MILE,i=GDistance(t,a)/METERS_PER_MILE;return 100>o&&100>s||100>r&&100>i}function getAPI(e,t,a){$.get(e,t,function(e){null!==e.exception&&console.log("Exception raised: "+e.exception),null!==a&&a(e.data)})}function postAPI(e,t,a){$.post(e,t,function(e){null!==a&&a(e)})}var s_map=null,s_kmpp=null,s_markers=[],s_centroids=[],s_paths=[],MILLIS_PER_HOUR=36e5,METERS_PER_MILE=1609.34,MIN_CLUSTERS=3,MAX_ZOOM=5,GMap=google.maps.Map,GPoint=google.maps.Point,GCircle=google.maps.Circle,GMarker=google.maps.Marker,GPolyline=google.maps.Polyline,GSymbolPath=google.maps.SymbolPath,GLatLng=google.maps.LatLng,GLatLngBounds=google.maps.LatLngBounds,GStyledMapType=google.maps.StyledMapType,GInfoWindow=google.maps.InfoWindow,GDistance=google.maps.geometry.spherical.computeDistanceBetween,GEvent=google.maps.event,s_style=[{featureType:"administrative",elementType:"labels.text.fill",stylers:[{color:"#444444"}]},{featureType:"landscape",elementType:"all",stylers:[{color:"#f2f2f2"}]},{featureType:"poi",elementType:"all",stylers:[{visibility:"off"}]},{featureType:"road",elementType:"all",stylers:[{saturation:-100},{lightness:45}]},{featureType:"road.highway",elementType:"all",stylers:[{visibility:"simplified"}]},{featureType:"road",elementType:"labels",stylers:[{visibility:"off"}]},{featureType:"road.arterial",elementType:"labels.icon",stylers:[{visibility:"off"}]},{featureType:"transit",elementType:"all",stylers:[{visibility:"off"}]},{featureType:"water",elementType:"all",stylers:[{color:"#46bcec"},{visibility:"on"}]}];$(document).ready(function(){s_map=new GMap(document.getElementById("map"),{center:new GLatLng(0,0),disableDefaultUI:!0,maxZoom:10,zoom:2}),s_map.mapTypes.set("s_style",new GStyledMapType(s_style)),s_map.setMapTypeId("s_style"),s_kmpp=new kmpp,GEvent.addListener(s_map,"zoom_changed",updatePaths),GEvent.addListener(s_map,"zoom_changed",updateCentroids);var e=dataToShow();"drunk"===e?(getLocations(!1),getDrunks()):"history"===e?getLocations(!0):"cluster"==e?getClusters():getLocations(!1)});
