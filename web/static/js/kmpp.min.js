var kmpp=function(){function t(){this.kmpp=!0,this.iterations=0,this.converged=!1,this.maxIterations=-1,this.k=0}var i=Math.abs,s=(Math.pow,Math.sqrt),o=Math.random,n=Math.round,r=Math.log,e="k cannot be zero",h=null;return h="function"==typeof Array.prototype.reduce?function(t){var i=[].slice.apply(arguments);return t=i.shift(),Array.prototype.reduce.apply(t,i)}:"function"==typeof _?_.reduce:function(t,i){for(var s,o=(v=t[0],1);o<t.length;)v=i(v,t[o],o++,t);return 2>o&s&&s(),v},t.prototype.reset=function(){this.iterations=0,this.converged=!1,this.points=[],this.centroids=[]},t.prototype.distance=function(t,s){return i(t.x-s.x)+i(t.y-s.y)},t.prototype.setPoints=function(t){this.reset(),this.points=t},t.prototype.guessK=function(){this.k=~~s(.5*this.points.length)},t.prototype.chooseRandomCentroids=function(){for(var t=0;t<this.k;++t){var i=~~(o()*this.points.length),s={centroid:t,x:this.points[i].x,y:this.points[i].y,items:0};this.centroids[t]=s}},t.prototype.cluster=function(t){if(0===this.k){if("function"!=typeof t)throw new Error(e);return void t(new Error(e))}for(;!this.converged||this.maxIterations>0&&this.iterations>this.maxIterations;)this.iterate();"function"==typeof t&&t(null,this.centroids)},t.prototype.iterate=function(){var t,i;if(this.converged!==!0){this.converged=!0,++this.iterations;var s=new Array(this.k);for(t=0;t<this.k;++t)s[t]=[0,0,0];for(t=0,l=this.points.length;t<l;++t){var o=0,n=this.distance(this.centroids[0],this.points[t]);for(i=1;i<this.centroids.length;i++){var r=this.distance(this.centroids[i],this.points[t]);n>r&&(n=r,o=i)}("number"!=typeof this.points[t].centroid||this.points[t].centroid!==o)&&(this.converged=!1),this.points[t].centroid=o,s[o][0]+=this.points[t].x,s[o][1]+=this.points[t].y,++s[o][2]}for(t=0;t<this.k;++t)s[t][2]>0&&(this.centroids[t].x=s[t][0]/s[t][2],this.centroids[t].y=s[t][1]/s[t][2]),this.centroids[t].items=s[t][2]}},t.prototype.initCentroids=function(){var t,i,s,e,p=function(t,i){return t+i};if(this.kmpp!==!0)return void this.chooseRandomCentroids();var c=[],a=2+n(r(this.k)),d=this.points.length,f=this.points[~~(o()*d)];for(f.centroid=0,this.centroids=[f],t=0;d>t;++t)c[t]=this.distance(f,this.points[t]);var u=h(c,p);for(i=1;i<this.k;++i){var v=-1,y=-1;for(t=0;a>t;++t){for(var l=~~(o()*u),m=0;d>m&&!(l<=c[m]);++m)l-=c[m];for(var g=[],k=0;d>k;++k)s=c[k],e=this.distance(this.points[k],this.points[m]),g[k]=s>e?e:s;var x=h(g,p);(0>v||v>x)&&(v=x,y=m)}u=v;var M={x:this.points[y].x,y:this.points[y].y,centroid:i,items:0};for(this.centroids.push(M),t=0;d>t;++t)s=c[t],e=this.distance(this.points[y],this.points[t]),c[t]=s>e?e:s}},t}();"object"==typeof module&&(module.exports=kmpp);
