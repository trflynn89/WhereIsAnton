function getLocations(e){getAPI("/locations/",{limit:e?null:1},showLocations)}function getDrunks(){getAPI("/drunk/",{limit:1},showDrunks)}function createDrunk(e,t){postAPI("/drunk/",{time:e,drunk:t},null)}function timeComparator(e,t){return e.time<t.time?1:e.time>t.time?-1:0}function showLocations(e){e.sort(timeComparator),clearMap();for(var t=new GLatLngBounds,a=0;a<e.length;++a){var n=e[a].latitude,r=e[a].longitude,o=e[a].address,s=addMarker(n,r,o);t.extend(s)}fitBounds(t),drawPaths()}function showDrunks(e){var t=getName();if(0===e.length)return void Lobibox.alert("error",{title:"Nope!",msg:t+" has never been drunk :("});var a=e[0].drunk,n=new Date(e[0].time).getTime(),r=(new Date).getTime(),o=Math.ceil((r-n)/MILLIS_PER_HOUR);a&&o>s_drunkTimeout&&(sTime=n+s_drunkTimeout*MILLIS_PER_HOUR,createDrunk(sTime,!1),o=Math.ceil((r-sTime)/MILLIS_PER_HOUR),a=!1);var s=a?"Yes!":"Nope!",i=a?" drunk ":" sober ",l=1===o?" hour":" hours",p=a?" :)":" :(",u=a?"info":"error",m=t+" has been"+i+"for "+o+l+p;Lobibox.alert(u,{title:s,msg:m})}function clearMap(){for(var e=0;e<s_markers.length;++e)s_markers[e].setMap(null);for(var e=0;e<s_paths.length;++e){var t=s_paths[e].marker;t.setMap(null),s_arrows[e].setMap(null)}s_markers=[],s_arrows=[],s_paths=[]}function addMarker(e,t,a){for(var n=new GLatLng(e,t),r=new GMarker({position:n,optimized:!1,zIndex:1,map:s_map}),o=0;o<s_markers.length;++o)if(s_markers[o].position.equals(n)){r.setMap(null);break}return labelMarker(r,a),s_markers.push(r),n}function addArrow(e,t){var a=new GPolyline({path:[e,t],strokeOpacity:0,map:s_map,icons:[{icon:{path:GSymbolPath.BACKWARD_CLOSED_ARROW,strokeColor:"#993333",fillColor:"#993333",strokeWeight:2,strokeOpacity:1,fillOpacity:1},offset:"50%"}]});s_arrows.push(a)}function labelMarker(e,t){var a=e.getMap();if(null!==a&&void 0!==t){var n=new GInfoWindow({content:t});n.open(e.getMap(),e),e.addListener("click",function(){n.open(e.getMap(),e)})}}function fitBounds(e){var t=e.getSouthWest(),a=e.getNorthEast(),n=Math.max(t.lat(),a.lat()),r=Math.min(t.lat(),a.lat()),o=Math.max(t.lng(),a.lng()),s=Math.min(t.lng(),a.lng());s_map.fitBounds(new GLatLngBounds(new GLatLng(r,s),new GLatLng(n,o)))}function drawPaths(){for(var e=1;e<s_markers.length;++e){var t=s_markers[e-1].getPosition(),a=s_markers[e].getPosition(),n=calcCurvature(t,a);s_paths.push({start:t,end:a,curvature:n,marker:new GMarker({clickable:!1,optimized:!1,zIndex:0,map:s_map})})}updatePaths()}function updatePaths(){for(var e=s_map.getZoom(),t=1/Math.pow(2,-e),a=0;a<s_arrows.length;++a)s_arrows[a].setMap(null);s_arrows=[];for(var a=0;a<s_paths.length;++a){var n=s_paths[a];n.marker.setOptions(e>5?{icon:null}:{position:n.start,icon:{path:calcPath(n),scale:t,strokeColor:"#993333",strokeWeight:2}})}}function calcPath(e){var t=s_map.getProjection();if(void 0===t)return"";var a=t.fromLatLngToPoint(e.start),n=t.fromLatLngToPoint(e.end),r=new GPoint(n.x-a.x,n.y-a.y),o=new GPoint(r.x/2,r.y/2),s=new GPoint(r.y,-r.x),i=new GPoint(o.x+e.curvature*s.x,o.y+e.curvature*s.y),l=new GPoint((0+i.x)/2,(0+i.y)/2),p=new GPoint((i.x+r.x)/2,(i.y+r.y)/2),u=t.fromPointToLatLng(new GPoint(a.x+l.x,a.y+l.y)),m=t.fromPointToLatLng(new GPoint(a.x+p.x,a.y+p.y));return addArrow(u,m),"M 0,0 q "+i.x+","+i.y+" "+r.x+","+r.y}function calcCurvature(e,t){for(var a=.05,n=0;n<s_paths.length;++n){var r=s_paths[n];arePathsSimilar(r.start,r.end,e,t)&&(a+=.05)}return a}function arePathsSimilar(e,t,a,n){var r=GDistance(e,a)/METERS_PER_MILE,o=GDistance(t,n)/METERS_PER_MILE,s=GDistance(e,n)/METERS_PER_MILE,i=GDistance(t,a)/METERS_PER_MILE;return 100>r&&100>o||100>s&&100>i}function getAPI(e,t,a){setLoadStatus(!0),$.get(e,t,function(e){null!==a&&a(e.data),setLoadStatus(!1)})}function postAPI(e,t,a){$.post(e,t,function(e){null!==a&&a(e)})}function setLoadStatus(e){e?$(".hamburger").children().addClass("loading"):$(".hamburger").children().removeClass("loading")}var s_map=null,s_markers=[],s_arrows=[],s_paths=[],s_drunkTimeout=10,MILLIS_PER_HOUR=36e5,METERS_PER_MILE=1609.34,GMap=google.maps.Map,GPoint=google.maps.Point,GMarker=google.maps.Marker,GPolyline=google.maps.Polyline,GSymbolPath=google.maps.SymbolPath,GLatLng=google.maps.LatLng,GLatLngBounds=google.maps.LatLngBounds,GStyledMapType=google.maps.StyledMapType,GInfoWindow=google.maps.InfoWindow,GDistance=google.maps.geometry.spherical.computeDistanceBetween,GEvent=google.maps.event,s_style=[{featureType:"administrative",elementType:"labels.text.fill",stylers:[{color:"#444444"}]},{featureType:"landscape",elementType:"all",stylers:[{color:"#f2f2f2"}]},{featureType:"poi",elementType:"all",stylers:[{visibility:"off"}]},{featureType:"road",elementType:"all",stylers:[{saturation:-100},{lightness:45}]},{featureType:"road.highway",elementType:"all",stylers:[{visibility:"simplified"}]},{featureType:"road",elementType:"labels",stylers:[{visibility:"off"}]},{featureType:"road.arterial",elementType:"labels.icon",stylers:[{visibility:"off"}]},{featureType:"transit",elementType:"all",stylers:[{visibility:"off"}]},{featureType:"water",elementType:"all",stylers:[{color:"#46bcec"},{visibility:"on"}]}];$(document).ready(function(e){s_map=new GMap(document.getElementById("map"),{center:new GLatLng(0,0),disableDefaultUI:!0,maxZoom:10,zoom:2}),s_map.mapTypes.set("s_style",new GStyledMapType(s_style)),s_map.setMapTypeId("s_style"),GEvent.addListener(s_map,"zoom_changed",updatePaths);var t=dataToShow();"drunk"===t?(getLocations(!1),getDrunks()):getLocations("history"===t?!0:!1)});
