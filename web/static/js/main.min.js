function getLocations(e){s_showAll=e,getAPI("/locations/",showLocations)}function getDrunks(){getAPI("/drunk/",showDrunks)}function createDrunk(e,t){postAPI("/drunk/",{time:e,drunk:t})}function timeComparator(e,t){return e.time<t.time?1:e.time>t.time?-1:0}function showLocations(e){if(0!=e.length)if(e.sort(timeComparator),clearMap(),s_showAll){for(var t=new google.maps.LatLngBounds,o=0;o<e.length;++o){var s=e[o].latitude,a=e[o].longitude,r=e[o].address,n=addMarker(s,a,r);t.extend(n)}s_map.fitBounds(t),addPath()}else{var s=e[0].latitude,a=e[0].longitude,r=e[0].address;s_map.setCenter(new google.maps.LatLng(s,a)),s_map.setZoom(8),addMarker(s,a,r)}}function showDrunks(e){var t=getName();if(0==e.length)return void Lobibox.alert("error",{title:"Nope!",msg:t+" has never been drunk :("});e.sort(timeComparator);var o=e[0].drunk,s=new Date(e[0].time).getTime(),a=(new Date).getTime(),r=Math.ceil((a-s)/MILLIS_PER_HOUR);o&&r>s_drunkTimeout&&(sTime=s+s_drunkTimeout*MILLIS_PER_HOUR,createDrunk(sTime,!1),r=Math.ceil((a-sTime)/MILLIS_PER_HOUR),o=!1);var n=o?"Yes!":"Nope!",i=o?" drunk ":" sober ",u=1==r?" hour":" hours",l=o?" :)":" :(",m=o?"info":"error",p=t+" has been"+i+"for "+r+u+l;Lobibox.alert(m,{title:n,msg:p})}function addMarker(e,t,o){for(var s=new google.maps.LatLng(e,t),a=0;a<s_markers.length;++a){var r=s_markers[a].position;if(r.lat()===e&&r.lng()===t){o=null;break}}var n=new google.maps.Marker({position:s,optimized:!1,zIndex:1,map:s_map});return void 0!==o&&null!==o&&labelMarker(n,o),s_markers.push(n),s}function clearMap(){for(var e=0;e<s_curves.length;++e)s_curves[e].setMap(null);for(var e=0;e<s_markers.length;++e)s_markers[e].setMap(null);s_curves=[],s_markers=[],s_curvatures=[],s_pointPairs=[]}function labelMarker(e,t){var o=new google.maps.InfoWindow({content:t});o.open(e.getMap(),e),e.addListener("click",function(){o.open(e.getMap(),e)})}function addPath(){for(var e=0;e<s_markers.length-1;++e)s_curves.push(new google.maps.Marker({clickable:!1,optimized:!1,zIndex:0,map:s_map})),s_curvatures.push(rand(-.5,.5)),s_pointPairs.push([]),s_pointPairs[e].push(s_markers[e].getPosition()),s_pointPairs[e].push(s_markers[e+1].getPosition());google.maps.event.clearListeners(s_map,"zoom_changed"),google.maps.event.addListener(s_map,"zoom_changed",updateCurves),updateCurves()}function drawCurve(e){var t=s_pointPairs[e][0],o=s_pointPairs[e][1],s=s_map.getProjection(),a=s.fromLatLngToPoint(t),r=s.fromLatLngToPoint(o),n=new google.maps.Point(r.x-a.x,r.y-a.y),i=new google.maps.Point(n.x/2,n.y/2),u=new google.maps.Point(n.y,-n.x),l=new google.maps.Point(i.x+s_curvatures[e]*u.x,i.y+s_curvatures[e]*u.y),m="M 0,0 q "+l.x+","+l.y+" "+n.x+","+n.y,p=s_map.getZoom(),d=1/Math.pow(2,-p),g={path:m,scale:d,strokeWeight:2,strokeColor:"#993333"};s_curves[e].setOptions({position:t,icon:g})}function updateCurves(){for(var e=0;e<s_curves.length;++e)drawCurve(e)}function getAPI(e,t){setLoadStatus(!0),$.get(e,function(e){"undefined"!=typeof t&&t(e.data),setLoadStatus(!1)})}function postAPI(e,t,o){$.post(e,t,function(e){"undefined"!=typeof o&&o(e)})}function setLoadStatus(e){e?$(".hamburger").children().addClass("loading"):$(".hamburger").children().removeClass("loading")}function rand(e,t){return Math.random()*(t-e)+e}var s_map=null,s_path=null,s_markers=[],s_curves=[],s_curvatures=[],s_pointPairs=[],s_showAll=!1,s_drunkTimeout=10,MILLIS_PER_HOUR=36e5;$(document).ready(function(e){s_map=new google.maps.Map(document.getElementById("map"),{disableDefaultUI:!0,center:{lat:0,lng:0},zoom:2}),getLocations(!1)});
