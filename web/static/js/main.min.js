function getLocations(e){s_showAll=e,getAPI("/locations/",showLocations)}function getDrunks(){getAPI("/drunk/",showDrunks)}function createDrunk(e,t){postAPI("/drunk/",{time:e,drunk:t})}function timeComparator(e,t){return e.time<t.time?1:e.time>t.time?-1:0}function showLocations(e){if(0!=e.length)if(e.sort(timeComparator),clearMap(),s_showAll){for(var t=new GLatLngBounds,a=0;a<e.length;++a){var n=e[a].latitude,o=e[a].longitude,r=e[a].address,s=addMarker(n,o,r);t.extend(s)}s_map.fitBounds(t),drawPaths()}else{var n=e[0].latitude,o=e[0].longitude,r=e[0].address;s_map.setCenter(new GLatLng(n,o)),s_map.setZoom(8),addMarker(n,o,r)}}function showDrunks(e){var t=getName();if(0==e.length)return void Lobibox.alert("error",{title:"Nope!",msg:t+" has never been drunk :("});e.sort(timeComparator);var a=e[0].drunk,n=new Date(e[0].time).getTime(),o=(new Date).getTime(),r=Math.ceil((o-n)/MILLIS_PER_HOUR);a&&r>s_drunkTimeout&&(sTime=n+s_drunkTimeout*MILLIS_PER_HOUR,createDrunk(sTime,!1),r=Math.ceil((o-sTime)/MILLIS_PER_HOUR),a=!1);var s=a?"Yes!":"Nope!",i=a?" drunk ":" sober ",u=1==r?" hour":" hours",d=a?" :)":" :(",m=a?"info":"error",l=t+" has been"+i+"for "+r+u+d;Lobibox.alert(m,{title:s,msg:l})}function clearMap(){for(var e=0;e<s_markers.length;++e)s_markers[e].setMap(null);for(var e=0;e<s_paths.length;++e){var t=s_paths[e].marker;t.setMap(null)}s_markers=[],s_paths=[]}function addMarker(e,t,a){for(var n=new GLatLng(e,t),o=new GMarker({position:n,optimized:!1,zIndex:1,map:s_map}),r=0;r<s_markers.length;++r)if(s_markers[r].position.equals(n)){o.setMap(null);break}return labelMarker(o,a),s_markers.push(o),n}function labelMarker(e,t){var a=e.getMap();if(null!==a&&void 0!==t){var n=new GInfoWindow({content:t});n.open(e.getMap(),e),e.addListener("click",function(){n.open(e.getMap(),e)})}}function drawPaths(){for(var e=1;e<s_markers.length;++e)s_paths.push({start:s_markers[e-1].getPosition(),end:s_markers[e].getPosition(),curvature:rand(-.5,.5),marker:new GMarker({clickable:!1,optimized:!1,zIndex:0,map:s_map})});updatePaths()}function updatePaths(){for(var e=s_map.getZoom(),t=0;t<s_paths.length;++t){var a=s_paths[t];a.marker.setOptions({position:a.start,icon:{path:calcPath(a),scale:1/Math.pow(2,-e),strokeColor:"#993333",strokeWeight:2}})}}function calcPath(e){var t=s_map.getProjection(),a=t.fromLatLngToPoint(e.start),n=t.fromLatLngToPoint(e.end),o=new GPoint(n.x-a.x,n.y-a.y),r=new GPoint(o.x/2,o.y/2),s=new GPoint(o.y,-o.x),i=new GPoint(r.x+e.curvature*s.x,r.y+e.curvature*s.y);return"M 0,0 q "+i.x+","+i.y+" "+o.x+","+o.y}function getAPI(e,t){setLoadStatus(!0),$.get(e,function(e){"undefined"!=typeof t&&t(e.data),setLoadStatus(!1)})}function postAPI(e,t,a){$.post(e,t,function(e){"undefined"!=typeof a&&a(e)})}function setLoadStatus(e){e?$(".hamburger").children().addClass("loading"):$(".hamburger").children().removeClass("loading")}function rand(e,t){return Math.random()*(t-e)+e}var s_map=null,s_markers=[],s_paths=[],s_showAll=!1,s_drunkTimeout=10,MILLIS_PER_HOUR=36e5,GMap=google.maps.Map,GPoint=google.maps.Point,GMarker=google.maps.Marker,GLatLng=google.maps.LatLng,GLatLngBounds=google.maps.LatLngBounds,GInfoWindow=google.maps.InfoWindow;$(document).ready(function(e){s_map=new GMap(document.getElementById("map"),{disableDefaultUI:!0,center:new GLatLng(0,0),zoom:2}),google.maps.event.addListener(s_map,"zoom_changed",updatePaths),getLocations(!1)});
