function getLocations(t){getAPI("/locations/",{limit:t?null:1},showLocations)}function getDrunks(){getAPI("/drunk/",{limit:1},showDrunks)}function createDrunk(t,e){postAPI("/drunk/",{time:t,drunk:e})}function timeComparator(t,e){return t.time<e.time?1:t.time>e.time?-1:0}function showLocations(t){t.sort(timeComparator),clearMap();for(var e=new GLatLngBounds,a=0;a<t.length;++a){var n=t[a].latitude,r=t[a].longitude,o=t[a].address,s=addMarker(n,r,o);e.extend(s)}fitBounds(e),drawPaths()}function showDrunks(t){var e=getName();if(0==t.length)return void Lobibox.alert("error",{title:"Nope!",msg:e+" has never been drunk :("});var a=t[0].drunk,n=new Date(t[0].time).getTime(),r=(new Date).getTime(),o=Math.ceil((r-n)/MILLIS_PER_HOUR);a&&o>s_drunkTimeout&&(sTime=n+s_drunkTimeout*MILLIS_PER_HOUR,createDrunk(sTime,!1),o=Math.ceil((r-sTime)/MILLIS_PER_HOUR),a=!1);var s=a?"Yes!":"Nope!",i=a?" drunk ":" sober ",u=1==o?" hour":" hours",m=a?" :)":" :(",l=a?"info":"error",g=e+" has been"+i+"for "+o+u+m;Lobibox.alert(l,{title:s,msg:g})}function clearMap(){for(var t=0;t<s_markers.length;++t)s_markers[t].setMap(null);for(var t=0;t<s_paths.length;++t){var e=s_paths[t].marker;e.setMap(null)}s_markers=[],s_paths=[]}function addMarker(t,e,a){for(var n=new GLatLng(t,e),r=new GMarker({position:n,optimized:!1,zIndex:1,map:s_map}),o=0;o<s_markers.length;++o)if(s_markers[o].position.equals(n)){r.setMap(null);break}return labelMarker(r,a),s_markers.push(r),n}function labelMarker(t,e){var a=t.getMap();if(null!==a&&void 0!==e){var n=new GInfoWindow({content:e});n.open(t.getMap(),t),t.addListener("click",function(){n.open(t.getMap(),t)})}}function fitBounds(t){var e=t.getSouthWest(),a=t.getNorthEast(),n=Math.max(e.lat(),a.lat()),r=Math.min(e.lat(),a.lat()),o=Math.max(e.lng(),a.lng()),s=Math.min(e.lng(),a.lng());s_map.fitBounds(new GLatLngBounds(new GLatLng(r,s),new GLatLng(n,o)))}function drawPaths(){for(var t=1;t<s_markers.length;++t){var e=s_markers[t-1].getPosition(),a=s_markers[t].getPosition(),n=calcCurvature(e,a);s_paths.push({start:e,end:a,curvature:n,marker:new GMarker({clickable:!1,optimized:!1,zIndex:0,map:s_map})})}updatePaths()}function updatePaths(){for(var t=1/Math.pow(2,-1*s_map.getZoom()),e=0;e<s_paths.length;++e){var a=s_paths[e];a.marker.setOptions({position:a.start,icon:{path:calcPath(a),scale:t,strokeColor:"#993333",strokeWeight:2}})}}function calcPath(t){var e=s_map.getProjection(),a=e.fromLatLngToPoint(t.start),n=e.fromLatLngToPoint(t.end),r=new GPoint(n.x-a.x,n.y-a.y),o=new GPoint(r.x/2,r.y/2),s=new GPoint(r.y,-r.x),i=new GPoint(o.x+t.curvature*s.x,o.y+t.curvature*s.y);return"M 0,0 q "+i.x+","+i.y+" "+r.x+","+r.y}function calcCurvature(t,e){for(var a=.05,n=0;n<s_paths.length;++n){var r=s_paths[n];arePathsSimilar(r.start,r.end,t,e)&&(a+=.05)}return a}function arePathsSimilar(t,e,a,n){var r=GDistance(t,a)/METERS_PER_MILE,o=GDistance(e,n)/METERS_PER_MILE,s=GDistance(t,n)/METERS_PER_MILE,i=GDistance(e,a)/METERS_PER_MILE;return 100>r&&100>o||100>s&&100>i}function getAPI(t,e,a){setLoadStatus(!0),$.get(t,e,function(t){"undefined"!=typeof a&&a(t.data),setLoadStatus(!1)})}function postAPI(t,e,a){$.post(t,e,function(t){"undefined"!=typeof a&&a(t)})}function setLoadStatus(t){t?$(".hamburger").children().addClass("loading"):$(".hamburger").children().removeClass("loading")}var s_map=null,s_markers=[],s_paths=[],s_drunkTimeout=10,MILLIS_PER_HOUR=36e5,METERS_PER_MILE=1609.34,GMap=google.maps.Map,GPoint=google.maps.Point,GMarker=google.maps.Marker,GLatLng=google.maps.LatLng,GLatLngBounds=google.maps.LatLngBounds,GInfoWindow=google.maps.InfoWindow,GDistance=google.maps.geometry.spherical.computeDistanceBetween;$(document).ready(function(t){s_map=new GMap(document.getElementById("map"),{disableDefaultUI:!0,center:new GLatLng(0,0),maxZoom:8,zoom:2}),google.maps.event.addListener(s_map,"zoom_changed",updatePaths),getLocations(!1)});
